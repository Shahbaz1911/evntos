rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Internal Test Collection: Allow any authenticated user to read.
    // This is for the /firebase-test page to verify the connection.
    match /internal-test-collection/{docId} {
      allow read: if request.auth != null;
    }

    // Events Collection
    match /events/{eventId} {
      // Anyone can read event details (for public event pages).
      allow read: if true;
      
      // Only the event creator can create, update, or delete their own event.
      allow create, update, delete: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Registrations Collection
    match /registrations/{registrationId} {
      // Anyone can create a registration (register for an event).
      allow create: if true;
      
      // Only the event owner can read the registrations for their event.
      // The scanner function also needs read access.
      allow read: if request.auth != null && request.auth.uid == get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.userId;

      // No one can update or delete registrations from the client-side for data integrity.
      allow update, delete: if false;
    }
  }
}
